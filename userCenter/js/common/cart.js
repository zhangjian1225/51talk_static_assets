"use strict";define("common/cart",["tplCommon","../common/layer"],function(t,e,a){$.fn.extend({unChecked:function(){return this.each(function(t,e){"radio"==e.type.toLowerCase()?$(e).attr("checked",!1).next().removeClass("check"):$(e).attr("checked",!1).next().removeClass("checked")})},checked:function(){return this.each(function(t,e){"radio"==e.type.toLowerCase()?$(e).attr("checked",!0).next().addClass("check"):$(e).attr("checked",!0).next().addClass("checked")})},addCheckbox:function(){return this.each(function(t,e){var a=$(e),o=$('<span class="u-ckb"></span>');if(a.after(o),a.prop("checked")&&o.addClass("checked"),a.prop("disabled"))return!0;o.parent().on("click",function(){$(this);return a.attr("checked",!a.prop("checked")),o.toggleClass("checked"),a.change(),!1})})}});var o=t("cookie"),s=t("json2"),n=t("../common/layer");function i(){this.cartBox=o.getCookie("cart")?s.parse(o.getCookie("cart")):{cart:[],earphone:"off",goods:{}},this.tplCommon=t("tplCommon"),this.now=1,this.totalPrice=0}i.prototype={init:function(){this.bindEvents(),this.addEvent(),$("input[type='checkbox'].f-dn").each(function(t,e){$(e).addCheckbox()});_.keys(this.cartBox.goods);this.initRender(),this.top=$("#cart .products").height(),this.nextEvent(),this.preEvent(),this.checkEarphone(),$("#cart [name='cart']").val(s.stringify(this.cartBox))},isInstallment:function(){var t=!1;for(var e in this.cartBox.goods)if(this.cartBox.goods[e].is_show_installment){t=!0,this.installment_num=this.cartBox.goods[e].installment_num;break}return t},getTotalPrice:function(){for(var t in this.totalPrice=0,this.cartBox.goods)this.totalPrice+=Number(this.cartBox.goods[t].price);"on"==this.cartBox.earphone&&(this.totalPrice=this.totalPrice+50),this.isInstallment()?$("#cart .jsTotal").html(this.totalPrice+"\u5143="+(this.totalPrice/this.installment_num).toFixed(2)+"\u5143 \xd7 12\u671f"):$("#cart .jsTotal").html(this.totalPrice)},initRender:function(){this.renderGoodsList(),this.renderMain(),this.pageRender(),this.getTotalPrice()},renderGoodsList:function(){var t=this.cartBox.goods;for(var e in $("#cart .jsWrap").html(""),0==_.keys(this.cartBox.goods).length?$("#cartBox .addeds").hide():$("#cartBox .addeds").show(),"on"==this.cartBox.earphone&&$("[name='earphone']").checked(),t)$("#cart .jsWrap").append(this.tplCommon.goodItem(t[e])),this.delEvent()},renderMain:function(){$(".jsCount").text(_.keys(this.cartBox.goods).length)},bindEvents:function(){var e=$("#cart");parseInt(e.css("right"));e.mouseenter(function(){this.timer=setTimeout(function(){e.stop().animate({right:0})},100)}).mouseleave(function(t){t.pageX<$(window).width()&&(clearTimeout(this.timer),e.stop().animate({right:-255}))});var t=this;$("#form-cart").attr("action",href_url+"/orderInfo"),$("#form-cart .jsSubmit").off().on("click",function(){if(0==t.cartBox.cart.length)return n.showFn("\u60a8\u8fd8\u6ca1\u6709\u9009\u8d2d\u5185\u5bb9\u4e0d\u80fd\u63d0\u4ea4\uff01"),!1;$.ajax({url:window.href_url+"/ajax/checkCart",type:"GET",async:!1,success:function(t){console.log(t),0!=t.status?$("#form-cart").submit():n.showFn(t.info)}})})},delEvent:function(){var e=this;$(".jsDelete").on("click",function(){var t=$(this).data("id");e.deleteGoods(t),$(this).parent().parent().remove()})},addEvent:function(){var e=this;$(".jsCart").on("click",function(){if(!$(this).hasClass("already-cart")){var t=$(this).attr("data-cart");t&&e.addGoods(s.parse(t))}})},addGoods:function(t){t=t;var e="",a=[];for(var o in this.cartBox.goods||(this.cartBox.goods={}),t)this.cartBox.goods[o]?a.push(t[o].title):(this.cartBox.goods[o]=t[o],e+=this.tplCommon.goodItem(t[o]));e&&($(".jsCart").text("\u5df2\u52a0\u5165\u8d2d\u7269\u8f66"),$(".jsCart").addClass("already-cart"),$(".jsWrap").append(e),$("#cart").stop().animate({right:0}),this.delEvent(),this.totalPrice=0,this.updateCookie(),this.pageRender())},deleteGoods:function(t){(delete this.cartBox.goods[t],this.totalPrice=0,$(".jsCart").attr("data-cart"))&&(s.parse($(".jsCart").attr("data-cart"))[t]&&$(".jsCart").removeClass("already-cart").text("\u52a0\u5165\u8d2d\u7269\u8f66"));this.updateCookie(),this.pageRender()},updateCookie:function(){this.cartBox.cart=_.keys(this.cartBox.goods),0==this.cartBox.cart.length?(this.cartBox.earphone="off",$("#cart .addeds").hide(),$("[name='earphone']").unChecked()):$("#cart .addeds").show(),o.setCookie("cart",s.stringify(this.cartBox)),$("#cart [name='cart']").val(s.stringify(this.cartBox)),this.getTotalPrice(),this.renderMain()},pageRender:function(){this.iPages=3,this.count=_.keys(this.cartBox.goods).length,this.total=Math.ceil(this.count/this.iPages),0==this.total||1==this.total?($(".jsPageCount").text(1),$("#cart .next").addClass("dis-next"),$("#cart .prev").addClass("dis-prev"),this.now=1):($(".jsPageCount").text(this.total),$("#cart .next").removeClass("dis-next")),this.now>this.total?(this.now=this.total,$("#cart .jsWrap").animate({top:-(this.now-1)*this.top}),0==this.now&&(this.now=1)):1==this.now&&$("#cart .jsWrap").animate({top:0}),0==this.total?$(".jsPageNow").text(1):$(".jsPageNow").text(this.now),this.now==this.total&&1<this.now&&$("#cart .next").addClass("dis-next")},preEvent:function(){var t=this;$("#cart .prev").on("click",function(){$(this).hasClass("dis-prev")||(t.now--,$("#cart .jsPageNow").text(t.now),$("#cart .next").removeClass("dis-next"),$("#cart .jsWrap").stop().animate({top:-(t.now-1)*t.top}),1==t.now&&$(this).addClass("dis-prev"))})},nextEvent:function(){var t=this;$("#cart .next").on("click",function(){$(this).hasClass("dis-next")||(t.now++,$("#cart .jsPageNow").text(t.now),$("#cart .jsWrap").stop().animate({top:-(t.now-1)*t.top},300),$("#cart .prev").removeClass("dis-prev"),t.now==t.total&&$(this).addClass("dis-next"))})},checkEarphone:function(){var t=this;$("[name='earphone']").on("change",function(){1==$("#cart [name='earphone']:checked").length?t.cartBox.earphone="on":t.cartBox.earphone="off",t.updateCookie()})}},a.exports=new i});